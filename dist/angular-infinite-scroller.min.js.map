{"version":3,"sources":["webpack:///webpack/bootstrap f12d63fdcb1b6bf4c671","webpack:///./src/module.ts","webpack:///./src/descriptor.ts","webpack:///./src/scroll-settings.ts","webpack:///./src/elements-manager.ts","webpack:///./src/dom-manager.ts","webpack:///./src/scroll-detector.ts","webpack:///./src/scroller.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","n","__esModule","object","property","prototype","hasOwnProperty","p","s","descriptor_1","elements_manager_1","dom_manager_1","scroll_detector_1","scroller_1","scrollerModule","angular","directive","priority","restrict","transclude","link","scope","element","attr","_ctrl","linker","descriptor","Descriptor","createFrom","domManager","DOMManager","scrollDetector","ScrollDetector","elementsManager","ElementsManager","Scroller","Subscribe","scroll_settings_1","settings","ScrollSettings","expressionDesc","parseExpression","infiniteScroller","CollectionExpression","collection","IndexExpression","index","TrackByExpression","trackBy","Scope","Settings","expression","match","Error","lhs","rhs","trackByExp","this","BufferSize","settingsObject","size","parseInt","isNaN","_a","_this","UpdateCollection","newCollection","fixDisplayWindow","fillBottom","updateScopes","cleanUpBottom","AddTop","countTillStop","displayFrom","newElement","transcludeElement","PrependElement","Element","items","unshift","AddBottom","parentBottom","GetScrollBottomPosition","overflowCounter","displayTo","length","item","AppendElement","push","blockEl","GetElementBottomPosition","RemoveTop","hasInvisibleChildren","el","GetScrollTopPosition","removeElement","RemoveBottom","GetElementTopPosition","endDiff","fixedFrom","childScope","$new","clone","splice","Remove","$destroy","$on","lastItem","containerElement","offsetTop","scrollTop","offsetHeight","container","append","prepend","AppendElementToContainer","containerToAppend","PrependElementToContainer","containerToPrepend","parent","CreateRevealerElement","remove","GetRelativePositionOf","elementRatio","FixScroll","relativePosition","scrollTo","lastScrollTop","BUFFER_COUNT","SubscribeToElement","parentEl","onscroll","current","bottom","scrollHeight","OnScrollDown","topElement","children","OnScrollUp","clientHeight","onCollectionUpdated","onScrollDown","$apply","onScrollUp","$watchCollection"],"mappings":"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","file":"angular-infinite-scroller.min.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap f12d63fdcb1b6bf4c671","import { Descriptor } from './descriptor';\r\nimport { ElementsManager } from './elements-manager';\r\nimport { DOMManager } from './dom-manager';\r\nimport { ScrollDetector } from './scroll-detector';\r\nimport { Scroller } from './scroller';\r\n\r\ndeclare var angular;\r\n\r\nexport const scrollerModule = angular.module('angular-infinite-scroller', []);\r\n\r\nscrollerModule.directive('infiniteScroller', () => {\r\n    return {\r\n        priority: 1000,\r\n        restrict: 'A',\r\n        transclude: 'element',\r\n        link: (scope: ng.IScope, element: ng.IAugmentedJQuery, attr: ng.IAttributes, _ctrl, linker: ng.ITranscludeFunction) => {\r\n            const descriptor = Descriptor.createFrom(scope, attr);\r\n            const domManager = new DOMManager(element);\r\n            const scrollDetector = new ScrollDetector(element);\r\n            const elementsManager = new ElementsManager(descriptor, domManager, linker);\r\n            const scroller = new Scroller(descriptor, scrollDetector, elementsManager);\r\n\r\n            scroller.Subscribe();\r\n        },\r\n    };\r\n});\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/module.ts","import { ScrollSettings } from './scroll-settings';\r\n\r\ninterface ExpressionDescriptor {\r\n    index: string;\r\n    collection: string;\r\n    trackBy: string;\r\n}\r\n\r\nexport class Descriptor {\r\n    public Settings: ScrollSettings;\r\n    public CollectionExpression: string;\r\n    public IndexExpression: string;\r\n    public TrackByExpression: string;\r\n    public Scope: ng.IScope;\r\n\r\n    private constructor() { }\r\n\r\n    static createFrom(scope: ng.IScope, attr: ng.IAttributes): Descriptor {\r\n        const settings = ScrollSettings.createFrom(attr);\r\n        const expressionDesc = Descriptor.parseExpression(attr.infiniteScroller);\r\n\r\n        const descriptor = new Descriptor();\r\n        descriptor.CollectionExpression = expressionDesc.collection;\r\n        descriptor.IndexExpression = expressionDesc.index;\r\n        descriptor.TrackByExpression = expressionDesc.trackBy;\r\n        descriptor.Scope = scope;\r\n        descriptor.Settings = settings;\r\n\r\n        return descriptor;\r\n    }\r\n\r\n    private static parseExpression(expression: string): ExpressionDescriptor {\r\n        // parser logic mostly copied from ngRepeater https://github.com/angular/angular.js/blob/master/src/ng/directive/ngRepeat.js\r\n        let match = expression.match(/^\\s*([\\s\\S]+?)\\s+in\\s+([\\s\\S]+?)(?:\\s+track\\s+by\\s+([\\s\\S]+?))?\\s*$/);\r\n\r\n        if (!match) {\r\n            throw Error(`Expected expression in form of '_item_ in _collection_[ track by _id_]' but got '${expression}'.`);\r\n        }\r\n\r\n        const lhs = match[1];\r\n        const rhs = match[2];\r\n        const trackByExp = match[3];\r\n\r\n        match = lhs.match(/^(?:(\\s*[$\\w]+))$/);\r\n\r\n        if (!match) {\r\n            throw Error(`'_item_' in '_item_ in _collection_' should be an identifier but got '${lhs}'.`);\r\n        }\r\n\r\n        return {\r\n            collection: rhs,\r\n            index: match[1],\r\n            trackBy: trackByExp,\r\n        };\r\n    }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/descriptor.ts","export class ScrollSettings {\r\n    BufferSize: number;\r\n\r\n    private constructor() {\r\n        this.BufferSize = 10;\r\n    }\r\n\r\n    static createFrom(attr: ng.IAttributes): ScrollSettings {\r\n        const settingsObject = new ScrollSettings();\r\n\r\n        if (attr['scrollBufferSize']) {\r\n            try {\r\n                const size = parseInt(attr['scrollBufferSize']);\r\n                if (isNaN(size))\r\n                    throw '';\r\n\r\n                settingsObject.BufferSize = size;\r\n            } catch {\r\n                throw 'could not initialize scroll settings, ScrollBufferSize is not a number';\r\n            }\r\n        }\r\n\r\n        return settingsObject;\r\n    }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/scroll-settings.ts","import { Descriptor } from './descriptor';\r\nimport { IDOMManager } from './dom-manager';\r\n\r\nexport type Item = {\r\n    Element: ng.IAugmentedJQuery;\r\n    Scope: ng.IScope;\r\n};\r\n\r\nexport interface IElementsManager {\r\n    UpdateCollection(newCollection: any[]): void;\r\n    AddTop(): void;\r\n    AddBottom(): void;\r\n    RemoveTop(): void;\r\n    RemoveBottom(): void;\r\n}\r\n\r\nexport class ElementsManager implements IElementsManager {\r\n    private collection: any[];\r\n    private items: Item[];\r\n    private displayFrom: number;\r\n    private displayTo: number;\r\n\r\n    constructor(private descriptor: Descriptor, private domManager: IDOMManager, private linker: ng.ITranscludeFunction) {\r\n        this.items = [];\r\n        this.displayFrom = 0;\r\n        this.displayTo = 0;\r\n\r\n        // this way the memory can only leak until the scroller lives\r\n        this.descriptor.Scope.$on('$destroy', () => {\r\n            this.items = [];\r\n        });\r\n    }\r\n\r\n    public UpdateCollection = (newCollection: any[]) => {\r\n        this.collection = newCollection;\r\n        this.fixDisplayWindow();\r\n        this.fillBottom();\r\n        this.updateScopes();\r\n        this.cleanUpBottom();\r\n    }\r\n\r\n    public AddTop = () => {\r\n        let countTillStop = this.descriptor.Settings.BufferSize;\r\n\r\n        let i = 0;\r\n        for (i = this.displayFrom - 1; i >= 0 && countTillStop > 0; i--) {\r\n            const newElement = this.transcludeElement(i);\r\n            this.domManager.PrependElement(newElement.Element);\r\n            this.items.unshift(newElement);\r\n\r\n            countTillStop--;\r\n        }\r\n\r\n        this.displayFrom = i + 1;\r\n    }\r\n\r\n    public AddBottom = () => {\r\n        const parentBottom = this.domManager.GetScrollBottomPosition();\r\n\r\n        // add this many children below visible area\r\n        let overflowCounter = this.descriptor.Settings.BufferSize;\r\n\r\n        let i = 0;\r\n        for (i = this.displayTo; i < this.collection.length && overflowCounter > 0; i++) {\r\n            const item = this.transcludeElement(i);\r\n            this.domManager.AppendElement(item.Element);\r\n            this.items.push(item);\r\n\r\n            const blockEl = item.Element;\r\n            const blockBottom = this.domManager.GetElementBottomPosition(blockEl);\r\n\r\n            if (blockBottom > parentBottom) {\r\n                overflowCounter--;\r\n            }\r\n        }\r\n\r\n        this.displayTo = i;\r\n    }\r\n\r\n    public RemoveTop = () => {\r\n        let hasInvisibleChildren = true;\r\n        while (hasInvisibleChildren) {\r\n            if (this.items.length <= this.descriptor.Settings.BufferSize) {\r\n                break;\r\n            }\r\n\r\n            const el = this.items[this.descriptor.Settings.BufferSize].Element;\r\n            const elementBottom = this.domManager.GetElementBottomPosition(el);\r\n            const scrollTop = this.domManager.GetScrollTopPosition();\r\n\r\n            if (elementBottom < scrollTop) {\r\n                this.removeElement(0);\r\n                this.displayFrom++;\r\n            } else {\r\n                hasInvisibleChildren = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    public RemoveBottom = () => {\r\n        if (this.items.length < this.descriptor.Settings.BufferSize) {\r\n            return;\r\n        }\r\n\r\n        let hasInvisibleChildren = true;\r\n        while (hasInvisibleChildren) {\r\n            const el = this.items[this.items.length - this.descriptor.Settings.BufferSize].Element;\r\n            const elementTop = this.domManager.GetElementTopPosition(el);\r\n            const bottom = this.domManager.GetScrollBottomPosition();\r\n\r\n            if (elementTop > bottom) {\r\n                this.removeElement(this.items.length - 1);\r\n                this.displayTo--;\r\n            } else {\r\n                hasInvisibleChildren = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    private fillBottom() {\r\n        const parentBottom = this.domManager.GetScrollBottomPosition();\r\n\r\n        // don't add more if elements are already out of sight\r\n        if (this.items.length > 0) {\r\n            const lastItem = this.items[this.items.length - 1];\r\n            const lastItemBottom = this.domManager.GetElementBottomPosition(lastItem.Element);\r\n\r\n            if (lastItemBottom > parentBottom) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        this.AddBottom();\r\n    }\r\n\r\n    private updateScopes = () => {\r\n        for (let i = 0; i < this.items.length; i++) {\r\n            const item = this.items[i];\r\n            item.Scope[this.descriptor.IndexExpression] = this.collection[this.displayFrom + i];\r\n        }\r\n    }\r\n\r\n    private fixDisplayWindow = () => {\r\n        const endDiff = this.displayTo - this.collection.length;\r\n        if (endDiff > 0) {\r\n            this.displayTo -= endDiff;\r\n            const fixedFrom = this.displayFrom - endDiff;\r\n            this.displayFrom = fixedFrom > 0 ? fixedFrom : 0;\r\n        }\r\n    }\r\n\r\n    private cleanUpBottom = () => {\r\n        let i = this.collection.length;\r\n        while (i < this.items.length) {\r\n            this.removeElement(i);\r\n        }\r\n    }\r\n\r\n    private transcludeElement = (index: number): Item => {\r\n        const item = {} as Item;\r\n\r\n        const childScope = this.descriptor.Scope.$new();\r\n        childScope[this.descriptor.IndexExpression] = this.collection[index];\r\n\r\n        this.linker(childScope, (clone: ng.IAugmentedJQuery) => {\r\n            item.Element = clone;\r\n            item.Scope = childScope;\r\n        });\r\n\r\n        return item;\r\n    }\r\n\r\n    private removeElement = (index: number) => {\r\n        const item = this.items.splice(index, 1)[0];\r\n        this.domManager.Remove(item.Element);\r\n        item.Scope.$destroy();\r\n    }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/elements-manager.ts","declare var angular;\r\n\r\nexport interface IDOMManager {\r\n    CreateRevealerElement(): ng.IAugmentedJQuery;\r\n\r\n    AppendElement(element: ng.IAugmentedJQuery): void;\r\n    PrependElement(element: ng.IAugmentedJQuery): void;\r\n    AppendElementToContainer(element: ng.IAugmentedJQuery, containerToAppend: ng.IAugmentedJQuery): void;\r\n    PrependElementToContainer(element: ng.IAugmentedJQuery, containerToPrepend: ng.IAugmentedJQuery): void;\r\n\r\n    GetScrollBottomPosition(): number;\r\n    GetScrollTopPosition(): number;\r\n    GetRelativePositionOf(elementRatio: number): number;\r\n\r\n    GetElementBottomPosition(element: ng.IAugmentedJQuery): number;\r\n    GetElementTopPosition(element: ng.IAugmentedJQuery): number;\r\n\r\n    FixScroll(relativePosition: number);\r\n    Remove(element: ng.IAugmentedJQuery): void;\r\n}\r\n\r\nexport class DOMManager implements IDOMManager {\r\n    private container: ng.IAugmentedJQuery;\r\n    private containerElement: HTMLElement;\r\n\r\n    constructor(element: ng.IAugmentedJQuery) {\r\n        this.container = element.parent();\r\n        this.containerElement = this.container[0];\r\n    }\r\n\r\n    CreateRevealerElement(): ng.IAugmentedJQuery {\r\n        return angular.element('<div class=\"revealer\"></div>');\r\n    }\r\n\r\n    GetElementTopPosition(element: ng.IAugmentedJQuery): number {\r\n        return element[0].offsetTop;\r\n    }\r\n    Remove(element: ng.IAugmentedJQuery): void {\r\n        element.remove();\r\n    }\r\n    GetScrollTopPosition = () => {\r\n        return this.containerElement.offsetTop + this.containerElement.scrollTop;\r\n    }\r\n    GetElementBottomPosition(element: ng.IAugmentedJQuery) {\r\n        return element[0].offsetTop + element[0].offsetHeight;\r\n    }\r\n    GetScrollBottomPosition = () => {\r\n        return this.containerElement.offsetTop + this.containerElement.scrollTop + this.containerElement.offsetHeight;\r\n    }\r\n    GetRelativePositionOf(elementRatio: number): number {\r\n        return this.containerElement.offsetTop + this.containerElement.offsetHeight * elementRatio;\r\n    }\r\n    AppendElement = (element: ng.IAugmentedJQuery) => {\r\n        this.container.append(element);\r\n    }\r\n    PrependElement = (element: ng.IAugmentedJQuery) => {\r\n        this.container.prepend(element);\r\n    }\r\n    AppendElementToContainer = (element: ng.IAugmentedJQuery, containerToAppend: ng.IAugmentedJQuery) => {\r\n        containerToAppend.append(element);\r\n    }\r\n    PrependElementToContainer = (element: ng.IAugmentedJQuery, containerToPrepend: ng.IAugmentedJQuery) => {\r\n        containerToPrepend.prepend(element);\r\n    }\r\n    FixScroll(relativePosition: number) {\r\n        this.containerElement.scrollTo(0, this.containerElement.offsetHeight * relativePosition);\r\n    }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/dom-manager.ts","export class ScrollDetector {\r\n    private lastScrollTop = 0;\r\n    private BUFFER_COUNT = 5;\r\n\r\n    public OnScrollDown?: () => void;\r\n    public OnScrollUp?: () => void;\r\n\r\n    constructor(private element: ng.IAugmentedJQuery) { }\r\n\r\n    public SubscribeToElement = () => {\r\n        const parentEl: HTMLElement = this.element.parent()[0];\r\n\r\n        parentEl.onscroll = () => {\r\n            if (this.lastScrollTop < parentEl.scrollTop) {\r\n                const current = parentEl.scrollTop + parentEl.offsetHeight;\r\n                const bottom = parentEl.scrollHeight;\r\n\r\n                if (this.OnScrollDown && current === bottom) {\r\n                    this.OnScrollDown();\r\n                }\r\n            } else if (this.lastScrollTop > parentEl.scrollTop) {\r\n                const topElement = parentEl.children[0];\r\n                if (this.OnScrollUp && parentEl.scrollTop <= (topElement.clientHeight * this.BUFFER_COUNT)) {\r\n                    this.OnScrollUp();\r\n                }\r\n            }\r\n            this.lastScrollTop = parentEl.scrollTop;\r\n        };\r\n    }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/scroll-detector.ts","import { Descriptor } from './descriptor';\r\nimport { ScrollDetector } from './scroll-detector';\r\nimport { IElementsManager } from './elements-manager';\r\n\r\nexport class Scroller {\r\n    private get scope(): ng.IScope {\r\n        return this.descriptor.Scope;\r\n    }\r\n\r\n    public constructor(private descriptor: Descriptor, private scrollDetector: ScrollDetector, private elementsManager: IElementsManager) {\r\n        this.scrollDetector.OnScrollDown = this.onScrollDown;\r\n        this.scrollDetector.OnScrollUp = this.onScrollUp;\r\n    }\r\n\r\n    public Subscribe() {\r\n        this.scrollDetector.SubscribeToElement();\r\n        this.scope.$watchCollection(this.descriptor.CollectionExpression, this.onCollectionUpdated);\r\n    }\r\n\r\n    private onCollectionUpdated = (newCollection: any[]): void => {\r\n        this.elementsManager.UpdateCollection(newCollection);\r\n    }\r\n\r\n    private onScrollDown = (): void => {\r\n        this.scope.$apply(() => {\r\n            this.elementsManager.AddBottom();\r\n            this.elementsManager.RemoveTop();\r\n        });\r\n    }\r\n\r\n    private onScrollUp = (): void => {\r\n        this.scope.$apply(() => {\r\n            this.elementsManager.AddTop();\r\n            this.elementsManager.RemoveBottom();\r\n        });\r\n    }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/scroller.ts"],"sourceRoot":""}